#!/usr/bin/env bash

category=$1
[[ "$category" == "" ]] && category="work"

# Detect OS
OS="$(uname -s)"

# Get task description based on platform
case "$OS" in
    Darwin)
        pid=$(winh --get-pid)

        # macOS - use osascript
        description=$(osascript -e 'Tell application "System Events" to display dialog "Task to do:" default answer "" with title "['$category'] Insert description"' -e 'text returned of result' 2>/dev/null)

        winh --focus-pid $pid
        ;;
    Linux)
        # Linux - prefer zenity over rofi
        if command -v zenity >/dev/null 2>&1; then
            description=$(zenity --entry --title="[$category] Insert the description" --text="Task to do it" --entry-text="")
        elif command -v rofi >/dev/null 2>&1; then
            description=$(rofi -dmenu -p "Enter task name" -lines 0)
        else
            echo "Error: Neither zenity nor rofi found. Install one of them."
            exit 1
        fi
        ;;
    *)
        echo "Unsupported OS: $OS"
        exit 1
        ;;
esac

# Exit if cancelled or empty
[ -z "$description" ] && exit 1

# Send start notification
case "$OS" in
    Darwin)

        if command -v terminal-notifier >/dev/null 2>&1; then
            terminal-notifier -title "Task Timer" -message "Starting: $description" -sound default
        else
            osascript -e 'display notification "Starting timer for: '"$description"'" with title "Task Timer"'
        fi

        ;;
    Linux)
        notify-send "Starting timer for: $description"
        ;;
esac

# Run jn command
~/.local/bin/jn -t 1h -b 10 -c "$category" -n break -l "$description" -d
